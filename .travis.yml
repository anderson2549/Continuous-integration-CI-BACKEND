language: java

jdk:
  - openjdk17

services:
  - docker

before_install:
  - docker --version
  - docker compose version

install:
  - mvn clean package -DskipTests

script:
  - docker build -t backend-app:latest .

after_success:
  - docker compose down || true
  - docker compose up -d
  - sleep 40
  - docker compose ps
  - curl --retry 10 --retry-delay 10 --retry-connrefused http://localhost:8080/personas || exit 1

after_failure:
  - docker compose logs

notifications:
  email:
    on_success: change
    on_failure: always

branches:
  only:
    - main
    - Test-githubaction
